# ABOUTME: Docker Compose configuration for acp-relay development and deployment
# ABOUTME: Orchestrates relay server with volume mounts and environment configuration

services:
  relay:
    build:
      context: .
      dockerfile: Dockerfile.relay
    container_name: acp-relay
    command: ["/app/acp-relay", "serve", "--config", "/app/config/config-docker.yaml"]
    ports:
      - "23890:23890"  # HTTP API
      - "23891:23891"  # WebSocket
      - "23892:23892"  # Management API (consider restricting to localhost in production)
    volumes:
      # Mount configuration files (allows config changes without rebuild)
      - ./config-docker.yaml:/app/config/config-docker.yaml:ro
      - ./config.yaml:/app/config/config.yaml:ro
      # Mount working directory for development
      - ./:/app/workspace:rw
      # Mount data directory for database persistence
      - relay-data:/data
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - HOME=/home/relay
      - PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
      - XDG_DATA_HOME=/data
      - NPM_CONFIG_CACHE=/tmp/npm-cache
    env_file:
      - .env
    restart: unless-stopped
    networks:
      - acp-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:23890/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  relay-data:
    driver: local

networks:
  acp-network:
    driver: bridge
